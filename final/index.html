<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Text × Image Topography</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Libraries -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="libraries/p5.min.js"></script>
<script src="libraries/p5.sound.min.js"></script>

<style>
/* ============ page ============ */
body {
  margin: 0;
  background: #eaeaea;
  font-family: sans-serif;

  display: flex;
  align-items: center;
  justify-content: center;

  min-height: 100vh;
  overflow: auto;
}

.upload-preview {
  flex-direction: column;
  justify-content: flex-start;
  gap: 6px;
}

.upload-preview img {
  width: 100%;
  height: auto;
  max-height: 140px;
  object-fit: contain;
}

.upload-btn {
  font-size: 12px;
  
  cursor: pointer;
}

.upload-btn input {
  display: none;
}


#strip {
  display: grid;
  grid-template-columns: 1fr 1fr 160px 1fr 1fr;
  gap: 10px;

  width: 100%;
  max-width: 1200px;
  padding: 10px;

  box-sizing: border-box;
  min-width: 0;
}


.block {
  min-width: 0;
  min-height: 120px;

  align-items: center;
  justify-content: center;
  font-family: sans-serif;
  background: transparent;
  border: 1px solid #bbb;
    box-sizing:border-box;
  position: relative;
  overflow: visible;
}


.preview {
  width: 100%;
  height: 100%;
  min-height: 120px;

  display: flex;
  align-items: center;
  justify-content: center;

  color: #999;
  font-size: 12px;
  box-sizing: border-box;
}
.preview canvas{
    width: 100% !important;
    height: 100% !important;
    display:block;
}
.preview canvas,
.preview svg,
.preview img {
  max-width: 100%;
  max-height: 100%;
  display:block;
  width:100% !important;
    height:100% !important;
    min-width:0;
    min-height:0;
}


#remix-block {
  border: none;
}

#remix-block .preview {
  min-height: auto;
}

#remixBtn {
  padding: 12px 18px;
  font-size: 13px;
  cursor: pointer;
}


#text-block {
  display: flex;
}

#textInput {
  width: 100%;
  min-height: 1.4em;
  max-height: 80vh;

  resize: none;
  overflow: hidden;

  font-family: sans-serif;
  font-size: 13px;

  border: none;
  padding: 0;
  box-sizing: border-box;

  outline: none;
  background-color: transparent;   
}



#overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  display: none;
  z-index: 10;
}

#overlayContent {
  position: absolute;
  inset: 40px;
  background: white;
  padding: 12px;
  overflow: auto;
}

.clickable {
  cursor: pointer;
}

.preview canvas {
  width: auto !important;
  height: auto !important;
  max-width: 100%;
  max-height: 100%;
}

</style>
</head>

<body>

<div id="strip">

  <!-- Upload image -->
  <div class="block">
    <div class="preview upload-preview">
  <img id="imageThumb" style="display:none;">
  <label class="upload-btn">
    upload image
    <input type="file" id="imageUpload" accept="image/*">
  </label>
</div>

  </div>

  <!-- Processed Image (p5) -->
  <div class="block clickable">
    <div class="preview" id="p5-container">
      processed image
    </div>
  </div>

  <!-- Remix -->
  <div class="block" id="remix-block">
    <div class="preview">
      <button id="remixBtn">⟲</button>
    </div>
  </div>

  <!-- Topography -->
  <div class="block clickable">
    <div class="preview" id="out">
      graphed text
    </div>
  </div>

  <!-- Text -->
  <div class="block" id="text-block">
<textarea id="textInput" placeholder="   type text..."></textarea>
   
  </div>

</div>

<!-- Overlay -->
<div id="overlay" onclick="closeOverlay()">
  <div id="overlayContent"></div>
</div>

<!-- scripts -->
<script src="5.js"></script>
<script src="text.js"></script>

<script>
let originalImageURL = null;
</script>


<script>
const overlay = document.getElementById("overlay");
const overlayContent = document.getElementById("overlayContent");

let currentUploadImage = null; // p5.Image



document.querySelectorAll(".clickable").forEach(block => {
  block.addEventListener("click", e => {
    e.stopPropagation();
    overlayContent.innerHTML = "";

    
    if (block.querySelector("#imageThumb") && originalImageURL) {
      const img = document.createElement("img");
      img.src = originalImageURL;

      
      img.style.width = "auto";
      img.style.height = "auto";
      img.style.maxWidth = "none";
      img.style.maxHeight = "none";
      img.style.display = "block";

      overlayContent.appendChild(img);
    }

    
    else if (block.querySelector("canvas")) {
      const canvas = block.querySelector("canvas");
      const img = document.createElement("img");

      
      img.src = canvas.toDataURL("image/png");

      img.style.width = "auto";
      img.style.height = "auto";
      img.style.maxWidth = "none";
      img.style.maxHeight = "none";
      img.style.display = "block";

      overlayContent.appendChild(img);
    }

    
    else {
      const clone = block.cloneNode(true);
      overlayContent.appendChild(clone);
    }

    overlay.style.display = "block";
  });
});



function closeOverlay() {
  overlay.style.display = "none";
}
</script>
<script>
window.addEventListener("load", () => {
  document
    .querySelectorAll("canvas.p5Canvas")
    .forEach(c => {
      if (!c.closest("#p5-container")) {
        c.remove();
      }
    });
});
</script>

<script>
const imageUpload = document.getElementById("imageUpload");
const imageThumb  = document.getElementById("imageThumb");

document.getElementById("remixBtn").addEventListener("click", () => {
  if (window.currentDramaScore == null || !currentUploadImage) return;


  
  const level = dramaToLevel(window.currentDramaScore);

  
  const processedImg = get(); // p5.Image

  
  const remixedImage = remixBySingleColumn(processedImg);


  currentUploadImage = remixedImage;


  originalImageURL = currentUploadImage.canvas.toDataURL("image/png");

  
  updateUploadThumbnail(currentUploadImage);

  
  processP5Image(currentUploadImage);
});

imageUpload.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  
  const url = URL.createObjectURL(file);
  
  originalImageURL = url;

  imageThumb.src = url;
  imageThumb.style.display = "block";

  
  loadImage(url, img => {
    currentUploadImage = img; 
   
    processP5Image(img);

   
    const canvas = document.querySelector("canvas.p5Canvas");
    const container = document.getElementById("p5-container");

    if (canvas && container) {
      container.innerHTML = "";
      container.appendChild(canvas);
    }
  });
});

function updateUploadThumbnail(p5img) {
  const thumb = document.getElementById("imageThumb");
  thumb.src = p5img.canvas.toDataURL("image/png");
  thumb.style.display = "block";
}

</script>

</body>
</html>
